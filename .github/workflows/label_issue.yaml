name: Auto-add hardware label
on:
  issues:
    types: [opened, edited]

permissions:
  issues: write

jobs:
  label-hardware:
    runs-on: ubuntu-latest
    steps:
      - name: Get hardware selection
        id: get_hardware
        run: |
          ISSUE_BODY=$(jq -r '.issue.body' "$GITHUB_EVENT_PATH")
          
          HARDWARE_RAW=$(echo "$ISSUE_BODY" | awk '
            /^### Hardware Environment/ { flag=1; next }
            flag==1 && /^###/ { flag=0 }  # 遇到下一个标题则停止
            flag==1 { print $0 }  # 输出标题下的所有内容
          ')
          
          echo "$HARDWARE_RAW" | grep -oP '\[x\] \K.*' | tr '[:upper:]' '[:lower:]' > hardware_labels.txt
          
          HARDWARE_JSON=$(jq -R . hardware_labels.txt | jq -s .)
          
          echo "提取的硬件标签 JSON: $HARDWARE_JSON"
          echo "HARDWARE_JSON=$HARDWARE_JSON" >> "$GITHUB_ENV"

      - name: Add multiple hardware labels
        if: env.HARDWARE_JSON != '[]'
        uses: actions-ecosystem/action-add-labels@v1
        with:
          labels: ${{ fromJSON(env.HARDWARE_JSON) }}
