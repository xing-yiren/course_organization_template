name: Auto-add hardware label
on:
  issues:
    types: [opened, edited]

permissions:
  issues: write

jobs:
  label-hardware:
    runs-on: ubuntu-latest
    steps:
      - name: Get hardware selection
        id: get_hardware
        run: |
          ISSUE_BODY=$(jq -r '.issue.body' "$GITHUB_EVENT_PATH")
          
          HARDWARE_RAW=$(echo "$ISSUE_BODY" | awk '
            /^### Hardware Environment/ { flag=1; next }
            flag==1 && /^###/ { flag=0 }  # 遇到下一个标题则停止
            flag==1 { print $0 }  # 输出标题下的所有内容
          ')
          
          HARDWARE_LABELS=$(echo "$HARDWARE_RAW" | grep -oP '\[x\] \K.*' | tr '[:upper:]' '[:lower:]' | tr '\n' ',' | sed 's/,$//')
          
          echo "Extracted hardware: '$HARDWARE_RAW'"
          echo "Hardware label: '$HARDWARE_LABELS'"
          
          echo "HARDWARE_LABELS=$HARDWARE_LABELS" >> "$GITHUB_ENV"

      - name: Add hardware label to issue
        if: env.HARDWARE_LABELS != ''
        uses: actions-ecosystem/action-add-labels@v1
        with:
          labels: ${{ env.HARDWARE_LABELS }}
