name: Auto-add hardware label
on:
  issues:
    types: [opened, edited]

permissions:
  issues: write

jobs:
  label-hardware:
    runs-on: ubuntu-latest
    steps:
      - name: Get hardware selection
        id: get_hardware
        run: |
          ISSUE_BODY=$(jq -r '.issue.body' "$GITHUB_EVENT_PATH")
          
          HARDWARE_RAW=$(echo "$ISSUE_BODY" | awk '
            /^### Hardware Environment/ { flag=1; next }
            flag==1 && /^###/ { flag=0 }
            flag==1 { print $0 }
          ')
          
          echo "$HARDWARE_RAW" | grep -oP '\[x\] \K.*' | tr '[:upper:]' '[:lower:]' | sed '/^$/d' > hardware_labels.txt
          
          echo "Extracted label list: "
          cat hardware_labels.txt

      - name: Add each hardware label individually
        run: |
          while IFS= read -r label; do
            if [ -n "$label" ]; then
              echo "添加标签: $label"
              # 调用 GitHub API 逐个添加标签（避免插件格式问题）
              curl -X POST \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/labels" \
                -d "[\"$label\"]"
            fi
          done < hardware_labels.txt
