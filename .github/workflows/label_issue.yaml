name: Auto-add hardware label
on:
  issues:
    types: [opened, edited]

permissions:
  issues: write

jobs:
  label-hardware:
    runs-on: ubuntu-latest
    steps:
      - name: Get hardware selection
        id: get_hardware
        run: |
          ISSUE_BODY=$(jq -r '.issue.body' "$GITHUB_EVENT_PATH")
          
          HARDWARE_RAW=$(echo "$ISSUE_BODY" | awk '
            /^### Hardware Environment/ { flag=1; next }
            flag==1 && /^###/ { flag=0 }  # 遇到下一个标题则停止
            flag==1 { print $0 }  # 输出标题下的所有内容
          ')
          
          echo "$HARDWARE_RAW" | grep -oP '\[x\] \K.*' | tr '[:upper:]' '[:lower:]' > hardware_labels.txt
          
          HARDWARE_LABELS=$(echo "$HARDWARE_RAW" | grep -oP '\[x\] \K.*' | tr '[:upper:]' '[:lower:]' | sed '/^$/d')
          
          if [ -n "$HARDWARE_LABELS" ]; then
            HARDWARE_JSON=$(echo "$HARDWARE_LABELS" | jq -R . | jq -s 'map(select(length > 0))')
          else
            HARDWARE_JSON="[]"
          fi
          
          HARDWARE_JSON=$(echo "$HARDWARE_JSON" | tr -d '[:space:]' | sed 's/","/","/g')

          echo "JSON output: $HARDWARE_JSON"
          
          printf "HARDWARE_JSON=%s" "$HARDWARE_JSON" >> "$GITHUB_ENV"

      - name: Add multiple hardware labels
        if: env.HARDWARE_JSON != '[]'
        uses: actions-ecosystem/action-add-labels@v1
        with:
          labels: ${{ fromJSON(env.HARDWARE_JSON) }}
