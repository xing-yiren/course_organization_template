name: Auto-add hardware label
on:
  issues:
    types: [opened, edited]

permissions:
  issues: write

jobs:
  label-hardware:
    runs-on: ubuntu-latest
    steps:
      - name: Get hardware selection
        id: get_hardware
        run: |
          ISSUE_BODY=$(jq -r '.issue.body' "$GITHUB_EVENT_PATH")
          
          HARDWARE_RAW=$(echo "$ISSUE_BODY" | awk '
            /^### Hardware Environment/ { flag=1; next }
            flag==1 && /^###/ { flag=0 }
            flag==1 { print $0 }
          ')
          
          echo "$HARDWARE_RAW" | grep -oP '\[x\] \K.*' | tr '[:upper:]' '[:lower:]' | sed '/^$/d' > hardware_labels.txt
          
          echo "Extracted label list: "
          cat hardware_labels.txt

      - name: Get current labels on the issue
        id: get_current
        run: |
          CURRENT_LABELS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/labels" | jq -r '.[].name')
          
          echo "$CURRENT_LABELS" | grep -E '^(ascend|gpu|cpu)$' > current_labels.txt
          
          echo "Current label list: "
          cat current_labels.txt

      - name: Calculate labels to add/remove
        id: calc_diff
        run: |
          comm -23 <(sort target_labels.txt) <(sort current_labels.txt) > add_labels.txt

          comm -13 <(sort target_labels.txt) <(sort current_labels.txt) > remove_labels.txt

          echo "Labels to add: "
          cat add_labels.txt
          echo "Labels to remove"
          cat remove_labels.txt

      - name: Add missing labels
        run: |
          while IFS= read -r label; do
            if [ -n "$label" ]; then
              echo "Add label: $label"
              curl -X POST \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/labels" \
                -d "[\"$label\"]"
            fi
          done < add_labels.txt

      - name: Remove extra labels
        run: |
          while IFS= read -r label; do
            if [ -n "$label" ]; then
              echo "Remove label: $label"
              curl -X DELETE \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/labels/$label"
            fi
          done < remove_labels.txt

